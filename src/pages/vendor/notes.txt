import React, { useCallback, useRef, useState } from 'react'
import { GoogleMap, useJsApiLoader, Marker, Circle, Autocomplete } from '@react-google-maps/api'

const containerStyle = {
    width: '100vw',
    height: '100vh',
}

const defaultCenter = {
    lat: 56.1304,  // Latitude of Canada
    lng: -106.3468 // Longitude of Canada
}

const Maps = (props) => {
    console.log(props, "searchQuery")
    const { isLoaded } = useJsApiLoader({
        id: 'google-map-script',
        googleMapsApiKey: "AIzaSyDsc0jaxFvFYsc1b3Tblah0n1LV3RfZZDQ",
        // libraries: ["places"],
    })
    const autocompleteRef = useRef(null);
    const [center, setCenter] = useState(defaultCenter)
    const [markerPosition, setMarkerPosition] = useState(defaultCenter);
    const [map, setMap] = React.useState(null)

    const onLoad = React.useCallback(function callback(map) {
        // This is just an example of getting and using the map instance!!! don't just blindly copy!
        const bounds = new window.google.maps.LatLngBounds(center)
        map.fitBounds(bounds)

        setMap(map)
    }, [])
    const handlePlaceSelect = () => {
        const place = autocompleteRef.current.getPlace();
        if (place && place.geometry) {
            const location = place.geometry.location;
            const newCenter = { lat: location.lat(), lng: location.lng() };

            setMarkerPosition(newCenter);
            props.onSelectLocation(newCenter);

            // Move map to selected location
            if (map) {
                map.panTo(newCenter);
                map.setZoom(14);
            }
        }
    };
    const onUnmount = React.useCallback(function callback(map) {
        setMap(null)
    }, [])
    const worldBounds = {
        north: 85,   // Maximum latitude (prevents scrolling into blank space)
        south: -85,  // Minimum latitude
        west: -180,  // Westernmost longitude
        east: 180    // Easternmost longitude
    };

    const options = {
        restriction: {
            latLngBounds: worldBounds,  // Prevents excessive panning
            strictBounds: true,          // Enforces map within bounds
        },
        gestureHandling: "greedy", // Improves zooming experience
        minZoom: 3,  // Prevents zooming out too much
        maxZoom: 12, // Adjust for user experience
        // mapTypeControl: false, // Hide map type controls if needed
        // disableDefaultUI: false, // Keep other controls
        fullscreenControl: true, // Keep fullscreen option
        draggable: true, // Allow dragging, but within limits
        streetViewControl: false, mapTypeControl: false
    };
    const circleOptions = {
        strokeColor: "red",
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: "0x220000FF",
        fillOpacity: 0.35,
        radius: 500000, // Radius in meters (500km)
    };


    const geocodeLocation = useCallback(() => {
        if (!props.searchQuery) return;

        const geocoder = new window.google.maps.Geocoder();
        geocoder.geocode({ address: props?.searchQuery }, (results, status) => {
            if (status === "OK" && results[0]) {
                const location = results[0].geometry.location;
                const newCenter = { lat: location.lat(), lng: location.lng() };

                setCenter(newCenter);
                setMarkerPosition(newCenter);
            } else {
                // alert("Location not found. Please try another search.");
            }
        });
    }, [props?.searchQuery]);


    React.useEffect(() => {
        if (props?.searchQuery) {
            geocodeLocation();
        }
    }, [props?.searchQuery, geocodeLocation]);
    return isLoaded ? (
        <GoogleMap
            mapContainerStyle={containerStyle}
            defaultCenter={defaultCenter}
            zoom={10}
            options={options}
            onLoad={onLoad}
            onUnmount={onUnmount}
        >
            {/* Child components, such as markers, info windows, etc. */}
            <Marker position={markerPosition} title={props?.searchQuery || 'You are here'} />
            {/* <Circle center={center} options={circleOptions} /> */}
        </GoogleMap>
    ) : (
        <></>
    )
}

export default Maps